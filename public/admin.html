<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Admin - Comparador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      td input,
      th,
      td {
        font-size: 0.85rem;
        padding: 4px;
      }
      input.form-control {
        font-size: 0.8rem;
        padding: 2px 4px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h3 class="text-center mb-4">🛠️ Panel de Administración</h3>

      <div class="table-responsive">
        <table class="table table-bordered" id="tabla">
          <thead class="table-dark">
            <tr>
              <th>Producto</th>
              <th>Precio 🇺🇾</th>
              <th>Precio 🇧🇷</th>
              <th>Cantidad</th>
              <th>🗑️</th>
            </tr>
          </thead>
          <tbody id="editorBody"></tbody>
        </table>
      </div>

      <div class="text-center mb-3">
        <button class="btn btn-secondary" onclick="agregarFila()">
          ➕ Agregar Producto
        </button>
        <button class="btn btn-success" onclick="guardar()">
          💾 Guardar Cambios
        </button>
      </div>
    </div>

    <script>
      // Función para cargar datos actuales
      function cargarDatos() {
        fetch("/canasta")
          .then((res) => res.json())
          .then((data) => {
            const cuerpo = document.getElementById("editorBody");
            cuerpo.innerHTML = "";
            data.forEach((item) => {
              const fila = document.createElement("tr");
              fila.innerHTML = `
          <td><input type="text" class="form-control" value="${item.producto}"></td>
          <td><input type="number" class="form-control" value="${item.precio_uy}"></td>
          <td><input type="number" class="form-control" value="${item.precio_br}"></td>
          <td><input type="number" class="form-control" value="${item.cantidad}"></td>
          <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">✖️</button></td>
        `;
              cuerpo.appendChild(fila);
            });
          });
      }

      // Función para agregar una nueva fila vacía
      function agregarFila() {
        const cuerpo = document.getElementById("editorBody");
        const fila = document.createElement("tr");
        fila.innerHTML = `
    <td><input type="text" class="form-control"></td>
    <td><input type="number" class="form-control"></td>
    <td><input type="number" class="form-control"></td>
    <td><input type="number" class="form-control" value="1"></td>
    <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">✖️</button></td>
  `;
        cuerpo.appendChild(fila);
      }

      // Función para guardar la canasta editada
      function guardar() {
        const filas = document.querySelectorAll("#editorBody tr");
        const datos = Array.from(filas).map((fila) => ({
          producto: fila.children[0].querySelector("input").value,
          precio_uy:
            parseFloat(fila.children[1].querySelector("input").value) || 0,
          precio_br:
            parseFloat(fila.children[2].querySelector("input").value) || 0,
          cantidad:
            parseFloat(fila.children[3].querySelector("input").value) || 1,
        }));

        fetch("/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos),
        })
          .then((res) => res.json())
          .then((data) => {
            alert("✅ Cambios guardados correctamente");
          });
      }

      // Al cargar la página
      cargarDatos();
    </script>
  </body>
</html>
